substitutions:
  # Change this model to fit your particular one.
  # You can find it in Home Assistant as the device diagnostic "Model Name".
  model: "XY6509X" #"XY5008"
  device_name: "${model}-controller"
  device_friendly_name: "sinilink-${model}"
  device_description: "Power Supply"
  
  # Model specific settings (Don't change these!)
  # XY5008
  XY5008_voltage_maximum: "50"
  XY5008_voltage_accuracy: "2"
  XY5008_voltage_multiplier: "0.01"
  XY5008_current_maximum: "8"
  XY5008_current_accuracy: "3"
  XY5008_current_multiplier: "0.001"
  # XY6509X
  XY6509X_voltage_maximum: "65"
  XY6509X_voltage_accuracy: "2"
  XY6509X_voltage_multiplier: "0.01"
  XY6509X_current_maximum: "9"
  XY6509X_current_accuracy: "3"
  XY6509X_current_multiplier: "0.001"
  XY6509X_current_maximum: "585"
  # Documentation for XY6509X here: https://www.mikrocontroller.net/attachment/641206/Powermodule_XY-SK60_Mosbus_protocol_english.pdf
  

globals:
   - id:   vin_undervoltage_theshold
     type: float
     restore_value: no
     initial_value: '17'
  
esphome:
  name: $device_name
  friendly_name: $device_friendly_name
  comment: $device_description
  name_add_mac_suffix: false
  project:
    name: "sinilink.${devicename}"
    version: "1.0.0"

esp8266:
  board: esp01_1m

# Enable logging
logger:
  level: INFO
  # Disable logging via UART, since we're using this for modbus communication
  baud_rate: 0

# Enable status LED
status_led:
  pin:
    number: GPIO2
    inverted: true

web_server:
  port: 80
  local: true
  log: false

# Enable Home Assistant API
api:
#  encryption:
#    key: !secret home_assistant_key
  reboot_timeout: 0s
  
ota:
  password: ""

# Configure WiFi
wifi:
  networks:
  - ssid: !secret wifi_ssid1
    password: !secret wifi_password1
  - ssid: !secret wifi_ssid2
    password: !secret wifi_password2
    

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "${devicename} Fallback Hotspot"
    password: ""

text_sensor:
  - platform: wifi_info
    ip_address:
      name: ESP IP Address
      id: ip_address
      on_value:      
        then:
          - lambda: |-
          
  - platform: template
    name: "Turn On Time"
    lambda: |-
      char buffer[16];
      std::string ton_time;
      std::snprintf(buffer, 16, "%02d:%02d:%02d" , (int)id(OUT_H).state, (int)id(OUT_M).state, (int)id(OUT_S).state);
      ton_time = buffer;
      
      return {ton_time};
    update_interval: 1s

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Protection Status"
    id: "PROTECT"
    address: 16
    register_type: holding
    value_type: U_WORD
    bitmask: 0x1
    #entity_category: config
    filters:
      - map:
        - 0 -> Normal
        - 1 -> OVP over voltage protection
        - 2 -> OCP over current protection
        - 3 -> OPP output over power protection
        - 4 -> LVP input undervoltage protection
        - 5 -> OAH over capacity protection
        - 6 -> OHP overtime protection
        - 7 -> OTP over termperature protection
        - 8 -> OEP no output protection
        - 9 -> OWH over energy protection
        - 10 -> ICP over input current protection
        - 11 -> ETP external temperature protection

  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 22
    name: "Model"
    id: "MODEL"
    register_type: holding
    value_type: U_WORD
    #internal: true

  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 23
    name: "Firmware"
    id: "VERSION"
    register_type: holding
    value_type: U_WORD
    #internal: true

  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 48
    name: "Host Type"
    id: "MASTER"
    register_type: holding
    value_type: U_WORD
    #internal: true
    filters:
      - map:
        - 0x3B3A -> WiFi
        
  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 49
    name: "Wifi Configuration"
    id: "WIFI-CONFIG"
    register_type: holding
    value_type: U_WORD
    #internal: true
    filters:
      - map:
        - 0 -> Invalid 
        - 1 -> Station Mode
        - 2 -> AP Mode
  
  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 50
    name: "Wifi Status"
    id: "WIFI-STATUS"
    register_type: holding
    value_type: U_WORD
    #internal: true
    filters:
      - map:
        - 0 -> Invalid Network
        - 1 -> Station Connectec
        - 2 -> AP Connected
        - 3 -> Station Connecting...
        - 4 -> AP Connecting...

  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 51
    name: "IP4 First Two bytes"
    id: "IP4-H"
    register_type: holding
    value_type: U_WORD
    #internal: true

  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 52
    name: "IP4 Last Two bytes"
    id: "IP4-L"
    register_type: holding
    value_type: U_WORD
    #internal: true

interval:
  - interval: 5s
    then:
      - lambda: |-
          char ip[18];
          char *ptr =ip;
                  
          strncpy(ip,id(ip_address).state.c_str(),17);
          ip[17]=0;
          int ip1 = atoi(ptr);
          ptr = strchr( ptr, '.');
          if (ptr!=NULL) {
            int ip2 = atoi(++ptr);
            ptr = strchr( ptr, '.');
            if (ptr!=NULL) {
              int ip3 = atoi(++ptr);
              ptr = strchr( ptr, '.');
              if (ptr!=NULL) {
                int ip4 = atoi(++ptr);
                esphome::modbus_controller::ModbusController *controller = id(powersupply);
                // create the payload
                std::vector<uint16_t> wifi_data = { 0x3b3a, 2, 4, uint16_t((ip1 << 8) | ip2), uint16_t((ip3 << 8) | ip4) };
                // Create a ModBUS command item with the wifi information as the payload
                esphome::modbus_controller::ModbusCommandItem set_wifi_command =
                      esphome::modbus_controller::ModbusCommandItem::create_write_multiple_command(controller, 0x30, 5, wifi_data);
                // Submit the command to the send queue
                powersupply->queue_command(set_wifi_command);
              }
            }
          }
          
  - interval: 1s
    then:
      - lambda: |-
          esphome::modbus_controller::ModbusController *controller = id(powersupply);
          esphome::modbus_controller::ModbusCommandItem set_wifi_command =
              esphome::modbus_controller::ModbusCommandItem::create_read_command(controller, esphome::modbus_controller::ModbusRegisterType::HOLDING, 0x30, 5);
          // Submit the command to the send queue
          powersupply->queue_command(set_wifi_command);
          
  - interval: 0.5s
    then:
      - lambda: |-
          static int count = 0;
          static int delay_count = 0;
          static int uv_count = 0;
                    
          if ((id(output_switch).state) && (id(cutoff_current).state!=0) && (id(IOUT).state < id(cutoff_current).state)){
            if (count>=5) {
              count = 0;
              id(output_switch).turn_off();
              id(out_relay).turn_off();
            }
            else count++;              
          }
          else count=0;
          
          if (id(UIN).state < id(vin_undervoltage_theshold)) { if (uv_count<4) uv_count++; }
          else {
             if (id(output_switch).state) id(out_relay).turn_on();
             uv_count=0;
          }
             
          if (uv_count >=4) {
              id(out_relay).turn_off();
          }    
          
          if (id(out_relay).state) {
              if (id(output_switch).state) delay_count=0;
              else delay_count++;
          }
          else delay_count=0;
          
          if (delay_count>=120*3) { 
              id(out_relay).turn_off();
              delay_count=0;
          }    
          
captive_portal:

uart:
  id: mod_bus
  tx_pin: GPIO1
  rx_pin: GPIO3
  baud_rate: 115200
  data_bits: 8
  stop_bits: 1
  parity: none

modbus:
 id: modbus1
# send_wait_time: 1ms

modbus_controller:
  - id: powersupply
    ## This address should be set to the "Address" value in the config menu
    address: 0x01
    modbus_id: modbus1
    setup_priority: 600
    update_interval: 1s
    command_throttle: 1ms
    

sensor:
  
  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 2
    name: "Output voltage"
    id: "VOUT" # Output voltage display value
    device_class: voltage
    state_class: measurement
    unit_of_measurement: "V"
    register_type: holding
    value_type: U_WORD
    accuracy_decimals: ${${model}_voltage_accuracy}
    filters:
      - multiply: ${${model}_voltage_multiplier}

  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 3
    name: "Output current"
    id: "IOUT" # Output current display value
    device_class: current
    state_class: measurement
    unit_of_measurement: "A"
    register_type: holding
    value_type: U_WORD
    accuracy_decimals: ${${model}_current_accuracy}
    filters:
      - multiply: ${${model}_current_multiplier}

  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 4
    name: "Output Power"
    id: "POWER" # Output power display value
    device_class: power
    state_class: measurement
    unit_of_measurement: "W"
    register_type: holding
    value_type: U_WORD
    accuracy_decimals: 2
    filters:
      - multiply: 0.01

  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 5
    name: "Input voltage"
    id: "UIN" # Input voltage display value
    device_class: voltage
    unit_of_measurement: "V"
    register_type: holding
    value_type: U_WORD
    accuracy_decimals: ${${model}_voltage_accuracy}
    #accuracy_decimals: 3
    filters:
      - multiply: ${${model}_voltage_multiplier}
    #  - multiply: 0.01
  
  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 6
    name: "unknown-AH-LOW" #"Battery charge"
    id: "AH-LOW" # Output AH Low 16-bit output
    #device_class: "energy_storage"
    state_class: measurement
    unit_of_measurement: "Ah"
    #icon: "mdi:battery-60"
    register_type: holding
    value_type: U_DWORD_R
    #accuracy_decimals: 3
    #filters:
    #  - multiply: 0.001

  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 7
    name: "unknown-AH-HIGH" #"Battery charge"
    id: "AH-HIGH" # AH High 16-bit output
    #device_class: "energy_storage"
    state_class: measurement
    unit_of_measurement: "Ah"
    #icon: "mdi:battery-60"
    register_type: holding
    value_type: U_DWORD_R
    #accuracy_decimals: 3
    #filters:
    #  - multiply: 0.001

  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 8
    name: "unknown-WH-LOW" #"Battery charge"
    id: "WH-LOW" # WH Low 16-bit output
    #device_class: "energy_storage"
    state_class: measurement
    unit_of_measurement: "Wh"
    #icon: "mdi:battery-60"
    register_type: holding
    value_type: U_DWORD_R
    #accuracy_decimals: 3
    #filters:
    #  - multiply: 0.001

  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 9
    name: "unknown-WH-HIGH" #"Battery charge"
    id: "WH-HIGH" # WH High 16-bit output
    #device_class: "energy_storage"
    state_class: measurement
    unit_of_measurement: "Wh"
    #icon: "mdi:battery-60"
    register_type: holding
    value_type: U_DWORD_R
    #accuracy_decimals: 3
    #filters:
    #  - multiply: 0.001

  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 10
    name: "Output Hours"
    id: "OUT_H" # "Output Hours"
    unit_of_measurement: "hours"
    register_type: holding
    value_type: U_WORD
    #internal: true
  
  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 11
    name: "Output Minutes"
    id: "OUT_M" #"Output Minutes"
    unit_of_measurement: "minutes"
    register_type: holding
    value_type: U_WORD
    #internal: true
  
  - platform: modbus_controller
    modbus_controller_id: powersupply
    address: 12
    name: "Output Seconds"
    id: "OUT_S" #"Output Seconds"
    unit_of_measurement: "seconds"
    register_type: holding
    value_type: U_WORD
    #internal: true
    
  - platform: modbus_controller
    name: "System Temperature"
    id: "T_IN" 
    device_class: temperature
    state_class: measurement
    modbus_controller_id: powersupply
    register_type: holding
    address: 13
    value_type: S_WORD
    unit_of_measurement: "°C" # "°F"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    
  - platform: modbus_controller
    name: "External Temperature"
    id: "T_EX"
    state_class: measurement
    modbus_controller_id: powersupply
    register_type: holding
    address: 14
    value_type: S_WORD
    device_class: temperature
    unit_of_measurement: "°C" # "°F"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
      
#  - platform: modbus_controller
#    name: "Host type"
#    state_class: measurement
#    modbus_controller_id: powersupply
#    register_type: holding
#    address: 48
#    value_type: U_WORD
    #internal: true
       
binary_sensor:
 
  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Constant Voltage"
    id: "CVCC-CV"
    address: 17
    register_type: holding
    bitmask: 0x1
    filters:
      - invert:
      
  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Constant Current"
    id: "CVCC-CC"
    address: 17
    register_type: holding
    bitmask: 0x1 

number:
  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Set output voltage"
    device_class: voltage
    unit_of_measurement: "V"
    entity_category: config
    mode: box
    address: 0
    value_type: U_WORD
    min_value: 0
    max_value: ${${model}_voltage_maximum}
    step: ${${model}_voltage_multiplier}
    lambda: !lambda return x * ${${model}_voltage_multiplier};
    write_lambda: !lambda return x * (1/${${model}_voltage_multiplier});
  
  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Set output current"
    device_class: current
    unit_of_measurement: "A"
    entity_category: config
    mode: box
    address: 1
    value_type: U_WORD
    min_value: 0
    max_value: ${${model}_current_maximum}
    step: ${${model}_current_multiplier}
    lambda: !lambda return x * ${${model}_current_multiplier};
    write_lambda: !lambda return x * (1/${${model}_current_multiplier});
    
  - platform: template
    name: "Under current cutoff (battery charge)"
    id: cutoff_current
    device_class: current
    unit_of_measurement: "A"
    entity_category: config
    mode: box
    min_value: 0
    max_value: ${${model}_current_maximum}
    step: ${${model}_current_multiplier}
    optimistic: true

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Backlight"
    id: "B-LED"
    #device_class: current
    unit_of_measurement: "(0-5)"
    entity_category: config
    mode: slider
    address: 20
    value_type: U_WORD
    min_value: 0
    max_value: 5
    step: 1

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "SleepTime"
    id: "SLEEP"
    #device_class: current
    unit_of_measurement: "min"
    entity_category: config
    mode: slider
    address: 21
    value_type: U_WORD
    min_value: 0
    max_value: 65535 #????
    step: 1

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Slave Address"
    id: "SLAVE-ADD"
    device_class: data_rate
    #unit_of_measurement: "min"
    entity_category: config
    mode: box
    address: 24
    value_type: U_WORD
    min_value: 0
    max_value: 65535 #????
    step: 1

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Baudrate"
    id: "BAUDRATE_L"
    #device_class: current
    unit_of_measurement: "bps"
    entity_category: config
    mode: box
    address: 25
    value_type: U_WORD
    min_value: 0
    max_value: 8
    #Note 1: (0019H) Baud rate register meaning 0:9600 1:14400 2:19200 3:38400 4:56000 5:576000 6:115200 (7:2400 8:4800 supported by some devices
    step: 1

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Internal Temperature Offset"
    id: "T-IN-OFFSET"
    entity_category: config
    mode: box
    address: 26
    value_type: U_WORD
    min_value: 0
    max_value: 65535
    step: 0.1
    lambda: !lambda return x * 0.1;
    write_lambda: !lambda return x * (1/0.1);

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "External Temperature Offset"
    id: "T-EX-OFFSET"
    entity_category: config
    mode: box
    address: 27
    value_type: U_WORD
    min_value: 0
    max_value: 6553.5
    step: 0.1
    lambda: !lambda return x * 0.1;
    write_lambda: !lambda return x * (1/0.1);

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Quick Recall Data Groups"
    id: "EXTRACT-M"
    #device_class: current
    #unit_of_measurement: "bps"
    entity_category: config
    mode: slider
    address: 29
    value_type: U_WORD
    min_value: 0
    max_value: 9 #????
    step: 1

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Full Power cut-off Current???"
    id: "BatFul"
    device_class: current
    unit_of_measurement: "A"
    entity_category: config
    mode: box
    address: 33
    value_type: U_WORD
    min_value: 0
    max_value: ${${model}_current_maximum}
    step: 1

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Constant Power Value"
    id: "CW"
    device_class: current
    unit_of_measurement: "W"
    entity_category: config
    mode: box
    address: 35
    value_type: U_WORD
    min_value: 0
    max_value: ${${model}_power_maximum}
    step: 1

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Voltage Setting"
    id: "V-SET-2"
    device_class: voltage
    unit_of_measurement: "V"
    entity_category: config
    mode: box
    address: 80
    value_type: U_WORD
    min_value: 0
    max_value: ${${model}_voltage_maximum}
    step: ${${model}_voltage_multiplier}
    lambda: !lambda return x * ${${model}_voltage_multiplier};
    write_lambda: !lambda return x * (1/${${model}_voltage_multiplier});

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Current Setting"
    id: "I-SET-2"
    device_class: current
    unit_of_measurement: "A"
    entity_category: config
    mode: box
    address: 81
    value_type: U_WORD
    min_value: 0
    max_value: ${${model}_current_maximum}
    step: ${${model}_current_multiplier}
    lambda: !lambda return x * ${${model}_current_multiplier};
    write_lambda: !lambda return x * (1/${${model}_current_multiplier});

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Input Undervoltage Protection"
    id: "S-LVP"
    device_class: voltage
    unit_of_measurement: "V"
    entity_category: config
    mode: box
    address: 82
    value_type: U_WORD
    min_value: 10
    max_value: 75
    step: ${${model}_voltage_multiplier}
    lambda: !lambda return x * ${${model}_voltage_multiplier};
    write_lambda: !lambda return x * (1/${${model}_voltage_multiplier});

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Over Voltage Protection"
    id: "S-OVP"
    device_class: voltage
    unit_of_measurement: "V"
    entity_category: config
    mode: box
    address: 83
    value_type: U_WORD
    min_value: 0
    max_value: 67
    step: ${${model}_voltage_multiplier}
    lambda: !lambda return x * ${${model}_voltage_multiplier};
    write_lambda: !lambda return x * (1/${${model}_voltage_multiplier});
    
  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Overcurrent Protection"
    id: "S-OCP"
    device_class: current
    unit_of_measurement: "A"
    entity_category: config
    mode: box
    address: 84
    value_type: U_WORD
    min_value: 0
    max_value: 9.2
    step: ${${model}_current_multiplier}
    lambda: !lambda return x * ${${model}_current_multiplier};
    write_lambda: !lambda return x * (1/${${model}_current_multiplier});

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Overpower Protection"
    id: "S-OPP"
    device_class: power
    unit_of_measurement: "W"
    entity_category: config
    mode: box
    address: 85
    value_type: U_WORD
    min_value: 0
    max_value: 650
    step: 0.1
    lambda: !lambda return x * 0.1;
    write_lambda: !lambda return x * (1/0.1);

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Maximum Output Duration Hours"
    id: "S-OHP_H"
    unit_of_measurement: "h"
    entity_category: config
    mode: box
    address: 86
    value_type: U_WORD
    min_value: 0
    max_value: 99
    step: 1

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Maximum Output Duration Minutes"
    id: "S-OHP_M"
    unit_of_measurement: "m"
    entity_category: config
    mode: box
    address: 87
    value_type: U_WORD
    min_value: 0
    max_value: 59
    step: 1

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Maximum Capacity low 16 bit"
    id: "S-OHA_L"
    unit_of_measurement: "Ah"
    entity_category: config
    device_class: current
    mode: box
    address: 89
    value_type: U_WORD
    min_value: 0
    #max_value: 99
    step: 1

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Maximum Capacity high 16 bit"
    id: "S-OHA_H"
    unit_of_measurement: "Ah"
    entity_category: config
    device_class: current
    mode: box
    address: 90
    value_type: U_WORD
    min_value: 0
    #max_value: 99
    step: 1

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Maximum Power low 16 bit"
    id: "S-OWH_L"
    unit_of_measurement: "Wh"
    entity_category: config
    device_class: power
    mode: box
    address: 90
    value_type: U_WORD
    min_value: 0
    #max_value: 99
    step: 1

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Maximum Power high 16 bit"
    id: "S-OWH_H"
    unit_of_measurement: "Wh"
    entity_category: config
    device_class: power
    mode: box
    address: 91
    value_type: U_WORD
    min_value: 0
    #max_value: 99
    step: 1

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Maximum Internal Temperature"
    id: "S-OTP"
    unit_of_measurement: "°C"
    entity_category: config
    device_class: temperature
    mode: box
    address: 92
    value_type: U_WORD
    min_value: 0
    max_value: 110
    step: 1

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Maximum External Temperature"
    id: "S-ETP"
    unit_of_measurement: "°C"
    entity_category: config
    device_class: temperature
    mode: box
    address: 94
    value_type: U_WORD
    min_value: 0
    max_value: 110
    step: 1

switch:

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Key Lock"
    id: "LOCK"
    address: 15
    register_type: holding
    bitmask: 0x1
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Output"
    id: "ONOFF"
    address: 18
    register_type: holding
    bitmask: 0x1
    entity_category: config
    
  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Temperature Symbol (on=F/off=C)"
    id: "FC"
    address: 19
    register_type: holding
    bitmask: 0x1
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Buzzer"
    id: "Buzzer"
    address: 28
    register_type: holding
    bitmask: 0x1
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Device Status"
    id: "DEVICE"
    address: 30
    register_type: holding
    bitmask: 0x1
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "MPPT Switch"
    id: "MPPT-SW"
    address: 31
    register_type: holding
    bitmask: 0x1
    entity_category: config
    inverted: true

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "MPPT Coefficient"
    id: "MPPT-K"
    address: 32
    register_type: holding
    bitmask: 0x1
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Constant Power Switch"
    id: "CW-SW"
    address: 34
    register_type: holding
    bitmask: 0x1
    entity_category: config
    inverted: true

  - platform: modbus_controller
    modbus_controller_id: powersupply
    name: "Power Output Switch"
    id: "S-INI"
    address: 93
    register_type: holding
    bitmask: 0x1
    entity_category: config
    inverted: true
   
  - platform: gpio
    id: out_relay
    name: "Output relay"
    pin:
      number: GPIO4
      inverted: false
